name: Production CI/CD

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: production-deploy
  cancel-in-progress: false

jobs:
  ci:
    name: CI Checks
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"
          cache-dependency-path: backend/requirements.txt

      - name: Install backend dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r backend/requirements.txt

      - name: Django system check
        run: python backend/manage.py check

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json

      - name: Install frontend dependencies
        run: npm ci
        working-directory: frontend

      - name: Frontend lint
        run: npm run lint
        working-directory: frontend

      - name: Frontend build
        run: npm run build
        working-directory: frontend

  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs:
      - ci
    environment:
      name: production
    steps:
      - name: Run deploy script on EC2 over SSH
        env:
          DEPLOY_HOST: ${{ secrets.PROD_HOST }}
          DEPLOY_USER: ${{ secrets.PROD_SSH_USER }}
          DEPLOY_PORT: ${{ secrets.PROD_SSH_PORT }}
          DEPLOY_KEY: ${{ secrets.PROD_SSH_PRIVATE_KEY }}
        run: |
          set -Eeuo pipefail

          if [[ -z "${DEPLOY_HOST}" || -z "${DEPLOY_USER}" || -z "${DEPLOY_KEY}" ]]; then
            echo "Missing required secrets: PROD_HOST, PROD_SSH_USER, PROD_SSH_PRIVATE_KEY"
            exit 1
          fi

          PORT="${DEPLOY_PORT:-22}"

          install -m 700 -d ~/.ssh
          printf '%s\n' "${DEPLOY_KEY}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -p "${PORT}" -H "${DEPLOY_HOST}" >> ~/.ssh/known_hosts

          ssh -p "${PORT}" -i ~/.ssh/id_ed25519 \
            -o BatchMode=yes \
            -o StrictHostKeyChecking=yes \
            "${DEPLOY_USER}@${DEPLOY_HOST}" \
            "sudo env SYNC_NGINX_TEMPLATE=false bash /srv/onlinedrawinggame/app/deploy/scripts/deploy_pull.sh main"

          rm -f ~/.ssh/id_ed25519
